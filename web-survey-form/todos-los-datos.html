<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todos los Datos Sprint</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 15px 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: #0066cc;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .email {
            font-weight: bold;
            color: #0066cc;
        }
        
        .hours {
            background: #0066cc;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
        }
        
        .date {
            color: #666;
            font-size: 13px;
        }
        
        .item {
            background: #f8f9fa;
            margin: 2px 0;
            padding: 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .high-priority { border-left: 4px solid #dc3545; }
        .medium-priority { border-left: 4px solid #ffc107; }
        .low-priority { border-left: 4px solid #28a745; }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn:hover {
            background: #0052a3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä TODOS LOS DATOS SPRINT</h1>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalHours">0h</div>
                <div class="stat-label">Total Horas</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgHours">0h</div>
                <div class="stat-label">Promedio</div>
            </div>
        </div>
        
        <button class="btn" onclick="loadAllData()">üîÑ Actualizar Datos</button>
        <button class="btn" onclick="exportData()">üìä Exportar CSV</button>
    </div>
    
    <div class="table-container">
        <div id="content">
            <div class="loading">üîÑ Cargando todos los datos...</div>
        </div>
    </div>

    <script>
        let allSubmissions = [];
        
        async function loadAllData() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">üîÑ Cargando todos los datos de la base de datos...</div>';
            
            try {
                console.log('Fetching data from AWS...');
                const response = await fetch('https://dubo90gxce.execute-api.us-east-1.amazonaws.com/prod/query');
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Data received:', data);
                
                if (data.success && data.submissions) {
                    allSubmissions = data.submissions;
                    console.log('Total submissions:', allSubmissions.length);
                    
                    updateStats();
                    showAllData();
                } else {
                    throw new Error('No se pudieron cargar los datos: ' + (data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error loading data:', error);
                content.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                document.getElementById('totalCount').textContent = 'Error';
                document.getElementById('totalHours').textContent = 'Error';
                document.getElementById('avgHours').textContent = 'Error';
            }
        }
        
        function updateStats() {
            const total = allSubmissions.length;
            const totalHours = allSubmissions.reduce((sum, s) => sum + (s.totalHours || 0), 0);
            const average = total > 0 ? Math.round(totalHours / total) : 0;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalHours').textContent = totalHours + 'h';
            document.getElementById('avgHours').textContent = average + 'h';
            
            console.log(`Stats updated: ${total} submissions, ${totalHours} hours, ${average}h average`);
        }
        
        function showAllData() {
            const content = document.getElementById('content');
            
            if (allSubmissions.length === 0) {
                content.innerHTML = '<div class="loading">üì≠ No hay datos en la base de datos</div>';
                return;
            }
            
            console.log('Rendering all data...');
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th style="width: 250px;">üìß Email</th>
                            <th style="width: 80px;">‚è±Ô∏è Horas</th>
                            <th style="width: 150px;">üìÖ Fecha</th>
                            <th>üìù Items Seleccionados</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Mostrar TODOS los registros sin l√≠mites
            allSubmissions.forEach((submission, index) => {
                const fecha = new Date(submission.submittedAt).toLocaleString('es-ES');
                
                let itemsHTML = '';
                if (submission.selections && submission.selections.length > 0) {
                    submission.selections.forEach(item => {
                        const priority = item.priority || 'unknown';
                        const priorityClass = priority === 'high' ? 'high-priority' : 
                                            priority === 'medium' ? 'medium-priority' : 'low-priority';
                        
                        const title = item.questionTitle || 'Pregunta desconocida';
                        const hours = item.estimatedHours || item.hours || 'TBD';
                        
                        itemsHTML += `<div class="item ${priorityClass}">${title} (${hours}h)</div>`;
                    });
                } else {
                    itemsHTML = '<div class="item">Sin selecciones</div>';
                }
                
                tableHTML += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td class="email">${submission.email}</td>
                        <td><span class="hours">${submission.totalHours || 0}h</span></td>
                        <td class="date">${fecha}</td>
                        <td>${itemsHTML}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            content.innerHTML = tableHTML;
            
            console.log(`Table rendered with ${allSubmissions.length} rows`);
        }
        
        function exportData() {
            if (allSubmissions.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            let csv = 'Numero,Email,Fecha,Total_Horas,Items_Seleccionados,Prioridades\n';
            
            allSubmissions.forEach((submission, index) => {
                const fecha = new Date(submission.submittedAt).toLocaleString('es-ES');
                const items = submission.selections ? 
                    submission.selections.map(item => `${item.questionTitle} (${item.estimatedHours || item.hours}h)`).join('; ') :
                    'Sin items';
                const priorities = submission.selections ?
                    submission.selections.map(item => item.priority).join('; ') :
                    'N/A';
                
                csv += `${index + 1},"${submission.email}","${fecha}",${submission.totalHours || 0},"${items}","${priorities}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `todos-los-datos-sprint-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Cargar datos autom√°ticamente al abrir la p√°gina
        document.addEventListener('DOMContentLoaded', loadAllData);
        
        // Auto-refresh cada 60 segundos
        setInterval(loadAllData, 60000);
    </script>
</body>
</html>
